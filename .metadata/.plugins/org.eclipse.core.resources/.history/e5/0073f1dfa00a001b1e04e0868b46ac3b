package com.progresssoft.service;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.transaction.Transactional;

import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.progresssoft.dao.DealDao;
import com.progresssoft.generic.service.GenericServiceImpl;
import com.progresssoft.model.Currency;
import com.progresssoft.model.Deal;
import com.progresssoft.utils.Logger;
import com.progresssoft.wrapper.DealDetailWrapper;

@Service
@Transactional
public class CurrencyServiceImpl extends GenericServiceImpl<Deal> implements DealService {

	private static final Logger logger = Logger.getLogger(CurrencyServiceImpl.class);

	@Autowired
	private DealDao dealDao;

	@Override
	public void saveDealsData(DealDetailWrapper dealDetailWrapper) {
		logger.logInfo("The new entered Deals Data is from currency : " + dealDetailWrapper.getFromCurrency()
				+ " to currency :" + dealDetailWrapper.getToCurrency());
		
		

		Map<String, Currency> mapCurrencies = new HashMap<>();
		for (Deal deal : dealsDataList) {
			Deal target = new Deal();
			if (mapDeals.containsKey(deal.getFromCurrency())) {
				int value = Integer.parseInt(String.valueOf((mapDeals.get(deal.getFromCurrency()))));
				mapDeals.put(deal.getFromCurrency(), ++value);
			} else {
				mapDeals.put(deal.getFromCurrency(), 1);
			}
			BeanUtils.copyProperties(deal, target);
			confirmedDeals.add(target);
		}
		List<AccumulativeDeal> accumulativeDeals = new ArrayList<>();
		for (Object key : mapDeals.keySet()) {
			AccumulativeDeal accumulativeDeal = new AccumulativeDeal();
			accumulativeDeal.setCount(new BigInteger(String.valueOf(mapDeals.get(key))));
			accumulativeDeal.setOderingCurrency(key.toString());
			accumulativeDeals.add(accumulativeDeal);
			System.out.println("Key = " + key + " - " + mapDeals.get(key));
		}
		dealDao.bulkValidSave(confirmedDeals, accumulativeDeals);
	}

}
